# 测试说明

## 新旧逻辑对比测试

### 配置开关

在 `src/App.tsx` 第 15 行：

```typescript
const USE_NEW_SUBSCRIBE_LOGIC = true; // 设置为 false 使用旧逻辑
```

### 新逻辑（推荐）

**特点：**

- 检查 `audioTrack.isPlaying` 避免重复订阅
- `user-unpublished` 时不执行 `unsubscribe`
- 减少不必要的订阅操作

**日志标识：** `[新逻辑]`

**测试步骤：**

1. 设置 `USE_NEW_SUBSCRIBE_LOGIC = true`
2. 打开浏览器控制台
3. 用户 A 成为主播
4. 用户 B 加入房间（观众）
5. 观察控制台日志：
   - 应该看到 `[新逻辑] 订阅并播放用户 xxx 的音频`
6. 用户 A 开麦/闭麦切换
7. 观察是否有重复订阅
8. 用户 A 下麦
9. 观察控制台：`[新逻辑] 用户 xxx 取消发布音频，不执行 unsubscribe`

### 旧逻辑

**特点：**

- 每次 `user-published` 都执行订阅
- 不检查是否已订阅

**日志标识：** `[旧逻辑]`

**测试步骤：**

1. 设置 `USE_NEW_SUBSCRIBE_LOGIC = false`
2. 重复上述测试步骤
3. 对比日志输出差异

## 主播角色测试

### 测试 setClientRole

**成为主播：**

1. 点击"成为主播"按钮
2. 检查控制台：应该看到 `成为主播成功`
3. 验证 `client.setClientRole("host")` 被调用

**下麦：**

1. 点击"下麦"按钮
2. 检查控制台：应该看到 `成为观众成功`
3. 验证 `client.setClientRole("audience")` 被调用

## 状态显示测试

### 麦克风状态

**测试场景：**

1. 主播闭麦：卡片显示 🔇 已闭麦（红色指示器）
2. 主播开麦但不说话：卡片显示 🎙️ 已开麦（绿色指示器）
3. 主播说话：卡片显示 🔊 正在说话（卡片放大动画）

### 音量检测

**验证点：**

- 音量 > 10：触发"正在说话"状态
- 音量 > 0 但 ≤ 10：显示"已开麦"
- 音量 = 0：显示"已闭麦"

## 多用户测试

### 测试步骤

1. **准备：** 打开 3 个浏览器窗口（或使用隐身模式）
2. **用户 A：** 加入房间 → 成为主播 → 开麦说话
3. **用户 B：** 加入房间 → 成为主播 → 保持闭麦
4. **用户 C：** 加入房间 → 保持观众身份

### 验证点

- 右上角总人数显示：3
- 主播列表显示：用户 A 和用户 B
- 用户 C 不在主播列表中
- 用户 A 说话时有动画效果
- 用户 B 显示闭麦状态
- 所有用户都能听到用户 A 的声音

## 分享链接测试

### 测试步骤

1. 用户 A 加入房间
2. 点击"分享房间"按钮
3. 复制链接
4. 在新窗口打开链接
5. 验证自动加入房间

### 验证点

- URL 包含 `appid` 和 `channel` 参数
- 自动跳过配置界面
- 直接进入房间

## 性能测试

### 监控指标

- 订阅次数（通过控制台日志统计）
- 内存使用情况
- CPU 使用率
- 音频延迟

### 对比测试

使用新旧逻辑分别测试，对比：

- 订阅操作次数
- 资源占用情况
- 音频质量

## 常见问题

### 重复订阅

**现象：** 控制台出现多次订阅同一用户的日志

**原因：**

- 旧逻辑：每次 `user-published` 都订阅
- 新逻辑：已修复，会检查 `isPlaying`

**解决：** 使用新逻辑（`USE_NEW_SUBSCRIBE_LOGIC = true`）

### 音频中断

**现象：** 主播开麦/闭麦切换时音频中断

**原因：** 可能是 `unsubscribe` 导致

**解决：** 新逻辑不执行 `unsubscribe`，保持连接

### 状态不同步

**现象：** 主播状态显示与实际不符

**原因：** 音量检测延迟或阈值设置

**调试：** 检查 `volume-indicator` 事件的 `level` 值
